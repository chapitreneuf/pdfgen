<CONTENT VERSION="1.0" LANG="fr" CHARSET="utf-8"/>

/**
 * Macro principale du générateur de PDF.
 * Initialisation puis routage vers le bon template (support des textes uniquement).
 * Utilisation : ./?do=_pdfgen_view&document=999
 */
<DEFMACRO NAME="PDFGEN_MAIN">
	<MACRO NAME="PDFGEN_HTML_START"/>
	
	<!--[ Recherche du type du document ]-->
	<MACRO NAME="PDFGEN_INIT_TYPE" />

	<SWITCH TEST="[%TPL_TYPE]">
		<DO CASE="article">
			<MACRO NAME="PDFGEN_ARTICLE_MAIN"/>
		</DO>
		<DO CASE="numero">
			<MACRO NAME="PDFGEN_NUMERO_MAIN"/>
		</DO>
		<DO CASE="default">
			<h1>[@PDFGEN.DOCUMENT] [#DOCUMENT]</h1>
			<p>[@PDFGEN.DOCUMENT_NOT_FOUND]</p>
		</DO>
	</SWITCH>

	<MACRO NAME="PDFGEN_HTML_END"/>
</DEFMACRO>

/**
 * Déterminer le type de template (globale [%TPL_TYPE]).
 * Voir : https://github.com/OpenEdition/checklist-lodel/blob/8cbaa5a06187e9d209c76aafa64a23e7056f85e6/tpl/macros_checklist.html#L19
 */
<DEFMACRO NAME="PDFGEN_INIT_TYPE">
	<LOOP NAME="pdfgen_init_type"
				TABLE="entities, types"
				SELECT="id, class, type"
				WHERE="id = '[#DOCUMENT]' AND class IN ('publications', 'textes') AND entities.idtype = types.id">
		<DO>
			<IF COND="[#CLASS] EQ 'textes'">
				<LET VAR="tpl_type" GLOBAL="1">article</LET>
			<ELSEIF COND="[#CLASS] EQ 'publications' AND [#TYPE] EQ 'numero'"/>
				<LET VAR="tpl_type" GLOBAL="1">numero</LET>
			</IF>
		</DO>
	</LOOP>
</DEFMACRO>

/**
 * Ouverture de la page HTML.
 */
<DEFMACRO NAME="PDFGEN_HTML_START">
	<!DOCTYPE html>
	<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>pdfgen (document [#DOCUMENT]) – [#OPTIONS.METADONNEESSITE.TITRESITE]</title>
		<MACRO NAME="PDFGEN_DEBUG_MODE" />
		<MACRO NAME="PDFGEN_HTML_PRELOAD"/>
		<MACRO NAME="PDFGEN_HTML_STYLES"/>
	</head>
	<body>
</DEFMACRO>

/**
 * Fermeture de la page HTML.
 */
<DEFMACRO NAME="PDFGEN_HTML_END">
	<MACRO NAME="PDFGEN_HTML_SCRIPTS"/>
	</body>
	</html>
</DEFMACRO>

/**
 * Afficher les message de la console sur la page quand debug=1.
 */
<DEFMACRO NAME="PDFGEN_DEBUG_MODE">
	<IF COND="[#DEBUG]">
		<pre id="log-container" style="background-color: #eee; padding: 10px;">Console:</pre>
		<script src="[#SHAREDIR]/plugins/custom/pdfgen/public/js/debug.js"></script>
	</IF>
</DEFMACRO>

/**
 * Préchargement du script d'initialisation.
 */
<DEFMACRO NAME="PDFGEN_HTML_PRELOAD">
	<link rel="preload" href="[#SHAREDIR]/plugins/custom/pdfgen/public/js/pdfgen.js" as="script" type="text/javascript"/>
</DEFMACRO>

/**
 * Styles CSS.
 */
<DEFMACRO NAME="PDFGEN_HTML_STYLES">
	<!-- normalize.css -->
	<link rel="stylesheet" href="[#SHAREDIR]/plugins/custom/pdfgen/public/vendor/normalize.css/normalize.css">

	<!-- Styles du PDF -->
	<link rel="stylesheet" href="[#SHAREDIR]/plugins/custom/pdfgen/public/css/pdfgen.css">

	<!--[ Hook pour l'insertion de CSS ]-->
	<MACRO NAME="PDFGEN_CUSTOM_CSS"/>
</DEFMACRO>

/**
 * Scripts JavaScript.
 */
<DEFMACRO NAME="PDFGEN_HTML_SCRIPTS">
	<script src="[#SHAREDIR]/plugins/custom/pdfgen/public/vendor/hyphenopoly/Hyphenopoly_Loader.js"></script>
	<script src="[#SHAREDIR]/plugins/custom/pdfgen/public/js/pdfgen.js"></script>
	<script src="[#SHAREDIR]/plugins/custom/pdfgen/public/vendor/pagedjs/paged.polyfill.js"></script>

	<!--[ Hook pour l'insertion de JS ]-->
	<MACRO NAME="PDFGEN_CUSTOM_JS"/>
</DEFMACRO>

/**
 * Hook pour l'insertion de CSS dans le head, à redéclarer dans macros_custom.html.
 */
<DEFMACRO NAME="PDFGEN_CUSTOM_CSS">
</DEFMACRO>

/**
 * Hook pour l'insertion de JS dans le head, à redéclarer dans macros_custom.html.
 */
<DEFMACRO NAME="PDFGEN_CUSTOM_JS">
</DEFMACRO>

/**
* Affiche la mention "Paru dans" :
* - Paru dans TITRESITE, NUMERO | PERIODE
* - Paru dans TITRESITE, TITRE rubrique, TITRE sous-rubrique
* @param {boolean} [citation] - Fonction appelée dans le contexte d'un "Pour citer".
*/
<DEFFUNC NAME="PDFGEN_PARU_DANS" OPTIONAL="citation">
	<em>[#OPTIONS.METADONNEESSITE.TITRESITE]</em>
	<IF COND="[#CITATION]"> [[@PDFGEN.EN_LIGNE]]</IF>

	<LOOP NAME="pdfgen_paru_dans" TABLE="relations, publications" SELECT="id,titre,numero,datepublipapier,datepubli,periode"
		WHERE="id2 = '[#ID]' AND type IN ('numero', 'rubrique') AND nature = 'P' AND id1 = publications.identity"
		ORDER="degree DESC" LIMIT="2">

		<BEFORE>, </BEFORE>

		<!--[ numéro / rubrique ]-->
		<IF COND="[#COUNT] EQ 1" />
		<IF COND="![#CITATION]"><a href="[#ID|makeurlwithid]"></IF>
		<IF COND="[#TYPE] EQ 'numero'">[#NUMERO]
			<FUNC NAME="PDFGEN_PERIODE_PUBLI" PREPEND="&nbsp;|&nbsp;" />
			<ELSE />[#TITRE]</IF>
		<IF COND="![#CITATION]"></a></IF>
		<!--[ sous-rubrique ]-->
		<ELSE />, [#TITRE]</IF>
	</LOOP>
</DEFFUNC>

/**
 * Obtenir la direction d'une langue. Retourne ltr ou rtl.
 * @param {string} lang - Langue à tester
 */
<DEFFUNC NAME="PDFGEN_GET_LANG_DIR" REQUIRED="lang">
	<IF COND="[#LANG|lang_is_rtl]">rtl<ELSE />ltr</IF>
</DEFFUNC>

/**
 * Affiche si disponible le titre traduit dans la langue de navigation, sinon le titre.
 * @param {boolean} [index] - Il s'agit du titre d'un index (remplace ML_TITLE).
 */
<DEFFUNC NAME="PDFGEN_ML_TITRE" OPTIONAL="index">
	<IF COND="[#INDEX]">
		<IF COND="[#ALTERTITLE:#SITELANG]">[#ALTERTITLE:#SITELANG]<ELSE/>[#TITLE]</IF>
	<ELSE />
		<IF COND="[#ALTERTITRE:#SITELANG]">[#ALTERTITRE:#SITELANG]<ELSE/>[#TITRE]</IF>
	</IF>	
</DEFFUNC>

/**
 * Affiche l'année de publication papier, ou de publication électronique, ou de création d'une publication.
 * @param {string} [wrap_class] - Valeur de l'attribut class.
 * @param {string} [prepend] - Texte à afficher avant la période.
 * @param {boolean} [textebrut] - Appel au filtre textebrut.
 */
<DEFFUNC NAME="PDFGEN_PERIODE_PUBLI" OPTIONAL="wrap_class, prepend, textebrut">
	<IF COND="![#PERIODE]">
		<IF COND="[#DATEPUBLIPAPIER|isadate]">
			<LET VAR="periode">[#DATEPUBLIPAPIER|formateddate("%Y")]</LET>
		<ELSEIF COND="[#DATEPUBLI|isadate]"/>
			<LET VAR="periode">[#DATEPUBLI|formateddate("%Y")]</LET>
		<ELSEIF COND="[#CREATIONDATE|isadate]"/>
			<LET VAR="periode">[#CREATIONDATE|formateddate("%Y")]</LET>
		</IF>
	</IF>
	<IF COND="[#PERIODE]">
		<IF COND="[#PREPEND]">
			<LET VAR="periode">[#PREPEND][#PERIODE]</LET>
		</IF>
		<IF COND="[#TEXTEBRUT]">
			<LET VAR="periode">[#PERIODE|textebrut]</LET>
		</IF>
		<IF COND="[#WRAP_CLASS]"/>
			<span class="[#WRAP_CLASS]">[#PERIODE]</span>
		<ELSE/>
			[#PERIODE]
		</IF>
	</IF>
</DEFFUNC>
